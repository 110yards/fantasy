from typing import Optional

from fastapi import Depends
from firebase_admin import firestore

from app.core.annotate_args import annotate_args
from app.core.base_command_executor import BaseCommand, BaseCommandExecutor, BaseCommandResult
from app.domain.enums.draft_state import DraftState
from app.domain.repositories.league_config_repository import LeagueConfigRepository, create_league_config_repository
from app.domain.repositories.league_repository import LeagueRepository, create_league_repository


def create_update_league_positions_command_executor(
    league_repo: LeagueRepository = Depends(create_league_repository), league_config_repo: LeagueConfigRepository = Depends(create_league_config_repository)
):
    return UpdateLeaguePositionsCommandExecutor(league_repo, league_config_repo)


@annotate_args
class UpdateLeaguePositionsCommand(BaseCommand):
    league_id: Optional[str] = None
    qb: int
    rb: int
    wr: int
    k: int
    lb: int
    dl: int
    db: int
    o_flex: int
    d_flex: int
    flex: int
    ir: int
    bye: int
    bench: int
    allow_bench_qb: bool = False
    allow_bench_rb: bool = False
    allow_bench_k: bool = False


@annotate_args
class UpdateLeaguePositionsResult(BaseCommandResult[UpdateLeaguePositionsCommand]):
    pass


class UpdateLeaguePositionsCommandExecutor(BaseCommandExecutor[UpdateLeaguePositionsCommand, UpdateLeaguePositionsResult]):
    def __init__(self, league_repo: LeagueRepository, league_config_repo: LeagueConfigRepository):
        self.league_repo = league_repo
        self.league_config_repo = league_config_repo

    def on_execute(self, command: UpdateLeaguePositionsCommand) -> UpdateLeaguePositionsResult:
        league = self.league_repo.get(command.league_id)

        if league.draft_state != DraftState.NOT_STARTED:
            return UpdateLeaguePositionsResult(command=command, error="Positions cannot be updated after draft has started")

        positions = self.league_config_repo.get_positions_config(command.league_id)

        positions.qb = command.qb
        positions.rb = command.rb
        positions.wr = command.wr
        positions.k = command.k
        positions.lb = command.lb
        positions.dl = command.dl
        positions.db = command.db
        positions.o_flex = command.o_flex
        positions.d_flex = command.d_flex
        positions.flex = command.flex
        positions.ir = command.ir
        positions.bye = command.bye
        positions.bench = command.bench
        positions.allow_bench_qb = command.allow_bench_qb
        positions.allow_bench_rb = command.allow_bench_rb
        positions.allow_bench_k = command.allow_bench_k

        if not positions.allow_bench_qb and positions.qb > 1:
            positions.qb = 1

        if not positions.allow_bench_k and positions.k > 1:
            positions.k = 1

        if not positions.allow_bench_rb and positions.rb > 1:
            positions.rb = 1

        league.positions = positions.create_positions()

        @firestore.transactional
        def update(transaction):
            self.league_repo.update(league, transaction)
            self.league_config_repo.set_positions_config(league.id, positions, transaction)

        transaction = self.league_repo.firestore.create_transaction()
        update(transaction)

        return UpdateLeaguePositionsResult(command=command)
